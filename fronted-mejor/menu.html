<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Menú - Mestiza Street Food</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="./style/style.css" />
</head>
<body class="pagina-blanca">

  <!-- Navbar igual al resto (full-width) -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom sticky-top">
    <div class="container-fluid px-3">
      <a class="navbar-brand d-flex align-items-center gap-2" href="index.html">
        <img src="./imagenes/FOTO_2.png" alt="Mestiza" class="brand-logo" />
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav"
              aria-controls="mainNav" aria-expanded="false" aria-label="Menu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Inicio</a></li>
          <li class="nav-item"><a class="nav-link" href="sobre_nosotros.html">Sobre Nosotros</a></li>
          <li class="nav-item"><a class="nav-link" href="opiniones.html">Opiniones</a></li>
          <li class="nav-item"><a class="nav-link active" href="menu.html">Menú</a></li>
        </ul>

        <ul class="navbar-nav ms-auto align-items-center gap-2">
          <li class="nav-item"><a class="nav-link" href="reservas.html">Reservas</a></li>
          <li class="nav-item"><a class="nav-link" href="calendario.html">Calendario</a></li>
          <li class="nav-item">
            <a href="#" class="nav-link position-relative" title="Ver Carrito"
               data-bs-toggle="offcanvas" data-bs-target="#cartOffcanvas" aria-controls="cartOffcanvas">
              <img src="./imagenes/carrito-de-compras.png" alt="Carrito" class="cart-icon" style="height:24px;">
              <span id="cart-counter" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">0</span>
            </a>
          </li>
          <li class="nav-item">
            <a href="estado.html" id="tracking-icon-link" class="nav-link p-2" style="display:none; color:#ffc107;">
              <i class="bi bi-basket3-fill" style="font-size:1.25rem;"></i>
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container my-5">
    <h1 class="text-center mb-5">Nuestro Menú</h1>

    <div id="notification-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050;"></div>

    <section id="catalog" class="mb-5">
      <div id="productos-grid" class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
        <!-- producto.js llenará este grid con cards -->
      </div>
    </section>

    <div class="productos-wrapper d-none">
      <h2>Productos (tabla)</h2>
      <div class="table-wrap">
        <table class="table">
          <thead>
            <tr><th>Nombre</th><th>Descripción</th><th>Precio</th></tr>
          </thead>
          <tbody id="contenedor-productos"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Footer igual al resto -->
  <footer class="bg-light py-4 mt-5">
    <div class="container text-center">
      <p class="mb-1">Bazzurro 1747 esq. B. Manton, Colonia Del Sacramento, Colonia, Uruguay 70000</p>
      <p class="mb-1">Tel: +598 98 107 643</p>
      <p class="mb-0 small text-muted">&copy; 2025 Mestiza Street Food</p>
      <div class="mt-3">
        <a href="https://www.instagram.com/mestiza_street_food/" target="_blank" rel="noopener" class="me-2">
          <img src="./imagenes/instagram.png" alt="Instagram" style="height:28px" />
        </a>
        <a href="https://www.facebook.com/p/mestiza_sabores_caseros-100036866965455/?_rdr" target="_blank" rel="noopener">
          <img src="./imagenes/facebook.png" alt="Facebook" style="height:28px" />
        </a>
      </div>
    </div>
  </footer>

  <!-- Offcanvas Carrito -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartOffcanvas" aria-labelledby="cartOffcanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartOffcanvasLabel">Tu Pedido</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <div id="cart-items-list" class="flex-grow-1 overflow-auto mb-3">
        <p class="text-muted text-center">El carrito está vacío. ¡Añade algo delicioso!</p>
      </div>
      <div class="mt-auto border-top pt-3">
        <div class="d-flex justify-content-between fw-bold mb-2">
          <span>Total:</span>
          <span id="cart-total">$0.00</span>
        </div>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-primary w-100" id="checkout-btn">Continuar Pedido</button>
          <button class="btn btn-outline-danger" id="clear-cart-btn">Vaciar Carrito</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal de personalización (sin cambios) -->
  <div class="modal fade" id="customizationModal" tabindex="-1" aria-labelledby="customizationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title" id="customizationModalLabel">Personalizar <span id="product-name-modal"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="product-id-modal">
          <h6 class="fw-bold text-success border-bottom pb-2">Tamaño / Cantidad (Precio Base)</h6>
          <div class="mb-3" id="size-options">
            <div class="form-check">
              <input class="form-check-input" type="radio" name="burgerSize" id="sizeSimple" value="300" data-name="Simple" checked>
              <label class="form-check-label" for="sizeSimple">Simple ($300)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="burgerSize" id="sizeDoble" value="400" data-name="Doble">
              <label class="form-check-label" for="sizeDoble">Doble ($400)</label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="burgerSize" id="sizeTriple" value="500" data-name="Triple">
              <label class="form-check-label" for="sizeTriple">Triple ($500)</label>
            </div>
          </div>

          <h6 class="fw-bold text-success border-bottom pb-2 mt-4">Adicionales (Incluidos)</h6>
          <div class="mb-3">
            <div class="form-check"><input class="form-check-input" type="checkbox" value="Cebollitas Brunoise" id="toppingCebollitasB"><label class="form-check-label" for="toppingCebollitasB">Cebollitas Brunoise</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" value="Cebollitas" id="toppingCebollitas"><label class="form-check-label" for="toppingCebollitas">Cebollitas</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="toppingPepinillos" value="Pepinillos Encurtidos" checked><label class="form-check-label" for="toppingPepinillos">Pepinillos Encurtidos</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="toppingCheddar" value="Cheddar" checked><label class="form-check-label" for="toppingCheddar">Cheddar</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="toppingSalsa" value="Salsa Mestiza" checked><label class="form-check-label" for="toppingSalsa">Salsa Mestiza</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="toppingGuacamole" value="Guacamole"><label class="form-check-label" for="toppingGuacamole">Guacamole</label></div>
            <div class="form-check"><input class="form-check-input" type="checkbox" id="toppingSalsaPicante" value="Salsa Picante"><label class="form-check-label" for="toppingSalsaPicante">Salsa Picante</label></div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <span class="h5 m-0">Total: <span id="final-price-display">$300.00</span></span>
          <button type="button" class="btn btn-success" id="btn-add-to-cart-modal">Añadir al carrito <span id="btn-price-display">($300.00)</span></button>
        </div>
      </div>
    </div>
  </div>

  <!-- Eliminado: botón "Continuar pedido" (no debe mostrarse en Menú) -->

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="./js/menu.js" defer></script>
  <script src="./js/cart.js" defer></script>
  <script src="./js/producto.js" defer></script>
  <script src="./js/pedidos.js" defer></script>

  <script>
    // Redirección desde el carrito (checkout) a dirección
     document.getElementById('checkout-btn')?.addEventListener('click', (e) => {
       e.preventDefault();
       e.stopImmediatePropagation();
       localStorage.removeItem('shippingInfo');
       localStorage.removeItem('paymentMethod');
       window.location.href = 'direccion.html';
     });
     document.querySelectorAll('a[href$="pago.html"]').forEach(a => {
       a.addEventListener('click', (e) => {
         e.preventDefault();
         e.stopImmediatePropagation();
         localStorage.removeItem('shippingInfo');
         localStorage.removeItem('paymentMethod');
         window.location.href = 'direccion.html';
       });
     });

     // Mostrar ícono de tracking sólo si hay un pedido reciente (TTL) y no está entregado/cancelado
     (function(){
       const a = document.getElementById('tracking-icon-link');
       if (!a) return;
       const TTL_MS = 4 * 60 * 60 * 1000; // 4 horas

       function hide(){ a.style.display='none'; }
       function show(id){ a.href=`estado.html?id=${id}`; a.style.display='inline-block'; a.title=`Ver estado del pedido #${id}`; }

       try{
         const raw = localStorage.getItem('lastOrder');
         const obj = raw ? JSON.parse(raw) : null;
         const id  = obj?.id || parseInt(localStorage.getItem('lastOrderId')||'0',10);
         const ts  = obj?.ts || 0;
         if (!id){ hide(); return; }
         // expira por tiempo
         if (ts && (Date.now()-ts) > TTL_MS){
           hide(); localStorage.removeItem('lastOrder'); localStorage.removeItem('lastOrderId'); return;
         }

         // Validar estado en backend (si está entregado/cancelado, ocultar)
         const ENDPOINTS = [
           '../admin/backend/pedidos/estado_publico.php',
           '/PROYECTO-FINAL/admin/backend/pedidos/estado_publico.php'
         ];
         (async()=>{
           for (const u of ENDPOINTS){
             try{
               const url = new URL(u, location.href); url.searchParams.set('id', id); url.searchParams.set('ts', Date.now());
               const r = await fetch(url.toString(), { cache:'no-store' });
               const t = await r.text();
               const j = JSON.parse(t);
               const estado = (j?.pedido?.estado || '').toLowerCase();
               if (estado==='entregado' || estado==='cancelado'){
                 hide(); localStorage.removeItem('lastOrder'); localStorage.removeItem('lastOrderId'); return;
               }
               show(id); return;
             }catch{ /* probar siguiente */ }
           }
           // si no pudimos validar, igualmente mostramos mientras no esté expirado
           show(id);
         })();
       }catch{ hide(); }
     })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>