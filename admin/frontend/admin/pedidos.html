<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pedidos - Admin</title>
  <link rel="stylesheet" href="../style/admin.css">
</head>
<body>
  <div id="root"></div>

  <script type="module">
    import { me, nav, logout } from '../js/admin-common.js';
    window._logout = logout;

    const root = document.getElementById('root');
    const u = await me();
    if (!u.ok) location.href = 'login.html';

    let estadoFiltro = '';
    let timer = null;
    let cacheIds = new Set();

    function btnEstado(id, estado) {
      return `<button data-id="${id}" data-estado="${estado}">${estado}</button>`;
    }

    function render(pedidos) {
      root.innerHTML = nav('pedidos') + `
        <main>
          <div class="card">
            <h2>Pedidos</h2>
            <div class="flex">
              <select id="filtro">
                <option value="">Todos</option>
                <option value="nuevo">Nuevo</option>
                <option value="aceptado">Aceptado</option>
                <option value="en_preparacion">En preparaci√≥n</option>
                <option value="en_camino">En camino</option>
                <option value="entregado">Entregado</option>
                <option value="cancelado">Cancelado</option>
              </select>
              <button id="ref" class="primary">Refrescar</button>
            </div>

            <table class="table" id="tb">
              <thead><tr>
                <th>ID</th><th>Fecha</th><th>Cliente</th><th>Tel</th><th>Direcci√≥n</th><th>Estado</th><th>Total</th><th>Detalle</th><th>Acciones</th>
              </tr></thead>
              <tbody>
                ${pedidos.map(p=>`
                  <tr>
                    <td>${p.id_pedido}</td>
                    <td>${p.fecha_hora}</td>
                    <td>${p.cliente_nombre ?? '-'}</td>
                    <td>${p.telefono ?? '-'}</td>
                    <td>${p.direccion ?? '-'}</td>
                    <td><span class="badge">${p.estado ?? '-'}</span></td>
                    <td>$ ${Number(p.total||0).toFixed(2)}</td>
                    <td>${p.detalle.map(d=>`${d.cantidad}x ${d.producto_nombre}`).join('<br>')}</td>
                    <td class="row grid-2">
                      ${btnEstado(p.id_pedido, 'aceptado')}
                      ${btnEstado(p.id_pedido, 'en_preparacion')}
                      ${btnEstado(p.id_pedido, 'en_camino')}
                      ${btnEstado(p.id_pedido, 'entregado')}
                      ${btnEstado(p.id_pedido, 'cancelado')}
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </main>
      `;

      const filtro = document.getElementById('filtro');
      filtro.value = estadoFiltro;
      filtro.onchange = () => { estadoFiltro = filtro.value; load(); };
      document.getElementById('ref').onclick = load;

      document.querySelector('#tb').onclick = async (e) => {
        const btn = e.target.closest('button'); if (!btn) return;
        const id = +btn.dataset.id, est = btn.dataset.estado;
        await fetch('../../backend/pedidos/update_estado.php', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({id_pedido:id, estado:est})
        });
        load(true);
      };
    }

    async function load(skipSound=false) {
      const url = new URL('../../backend/pedidos/list.php', location.href);
      if (estadoFiltro) url.searchParams.set('estado', estadoFiltro);
      const r = await fetch(url, {cache:'no-store'});
      const data = await r.json();

      const nuevos = data.filter(p=>!cacheIds.has(p.id_pedido)).map(p=>p.id_pedido);
      data.forEach(p=>cacheIds.add(p.id_pedido));
      if (nuevos.length && !skipSound) {
        new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=').play().catch(()=>{});
      }
      render(data);
    }

    await load(true);
    timer = setInterval(load, 5000);
    window.onbeforeunload = ()=> clearInterval(timer);
  </script>

  <!-- tema -->
  <script type="module">
    (function(){
      const KEY='admin_theme', html=document.documentElement;
      const apply=()=>{const s=localStorage.getItem(KEY);const prefers=matchMedia('(prefers-color-scheme: dark)').matches;
        if(s==='light') html.setAttribute('data-theme','light');
        else if(s==='dark') html.removeAttribute('data-theme');
        else { if(!prefers) html.setAttribute('data-theme','light'); else html.removeAttribute('data-theme'); }
      };
      apply();
      const attach=()=>{const h=document.querySelector('header'); if(!h) return false;
        if(!document.getElementById('theme-toggle')){const b=document.createElement('button'); b.id='theme-toggle'; b.className='btn';
          const upd=()=>{b.textContent=html.getAttribute('data-theme')==='light'?'‚òÄÔ∏è':'üåô';};
          b.onclick=()=>{const isLight=html.getAttribute('data-theme')==='light'; if(isLight){html.removeAttribute('data-theme');localStorage.setItem(KEY,'dark');} else {html.setAttribute('data-theme','light');localStorage.setItem(KEY,'light');} upd();};
          upd(); h.appendChild(b);
        } return true;
      };
      if(!attach()){const t=document.getElementById('root')||document.body; new MutationObserver((m,o)=>{if(attach()) o.disconnect();}).observe(t,{childList:true,subtree:true});}
    })();
  </script>

  <script src="./js/pedidos-admin.js" defer></script>
</body>
</html>
